name: CGM Pipeline

on:
  workflow_dispatch:
    inputs:
      xlsx_path:
        description: "Path to CGM XLSX file"
        default: "data/cgm.xlsx"
        required: true
      events_path:
        description: "Path to events JSON file"
        default: "data/events.json"
        required: false
      events_text_path:
        description: "Path to events text file"
        default: "data/events.txt"
        required: false
      question_path:
        description: "Path to question JSON file"
        default: "data/question.json"
        required: false
      output_dir:
        description: "Output directory"
        default: "output"
        required: true
      subject_id:
        description: "Subject identifier"
        required: false
      device_id:
        description: "Device identifier"
        required: false
      timezone:
        description: "IANA timezone"
        default: "Asia/Shanghai"
        required: true
      unit:
        description: "Glucose unit"
        default: "mg/dL"
        required: true
  push:
    paths:
      - "data/**"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pipeline
        run: |
          XLSX_PATH="${{ inputs.xlsx_path || 'data/cgm.xlsx' }}"
          EVENTS_PATH="${{ inputs.events_path || 'data/events.json' }}"
          EVENTS_TEXT_PATH="${{ inputs.events_text_path || 'data/events.txt' }}"
          QUESTION_PATH="${{ inputs.question_path || 'data/question.json' }}"
          OUTPUT_DIR="${{ inputs.output_dir || 'output' }}"
          SUBJECT_ID="${{ inputs.subject_id || vars.SUBJECT_ID }}"
          DEVICE_ID="${{ inputs.device_id || vars.DEVICE_ID }}"
          TIMEZONE="${{ inputs.timezone || vars.TIMEZONE || 'Asia/Shanghai' }}"
          UNIT="${{ inputs.unit || 'mg/dL' }}"

          SUBJECT_ARG=""
          DEVICE_ARG=""
          if [ -n "$SUBJECT_ID" ]; then
            SUBJECT_ARG="--subject-id $SUBJECT_ID"
          fi
          if [ -n "$DEVICE_ID" ]; then
            DEVICE_ARG="--device-id $DEVICE_ID"
          fi
          EVENTS_ARG=""
          EVENTS_TEXT_ARG=""
          QUESTION_ARG=""
          if [ -f "$EVENTS_TEXT_PATH" ]; then
            EVENTS_TEXT_ARG="--events-text $EVENTS_TEXT_PATH"
          elif [ -f "$EVENTS_PATH" ]; then
            EVENTS_ARG="--events-file $EVENTS_PATH"
          fi
          if [ -f "$QUESTION_PATH" ]; then
            QUESTION_ARG="--question-file $QUESTION_PATH"
          fi

          python -m cgm_pipeline.cli \
            "$XLSX_PATH" \
            "$OUTPUT_DIR" \
            $EVENTS_ARG \
            $EVENTS_TEXT_ARG \
            $QUESTION_ARG \
            $SUBJECT_ARG \
            $DEVICE_ARG \
            --timezone "$TIMEZONE" \
            --unit "$UNIT" \
            --pretty \
            --markdown \
            --verbose

      - name: Upload pipeline outputs
        uses: actions/upload-artifact@v4
        with:
          name: cgm-pipeline-output
          path: ${{ inputs.output_dir }}

      - name: Prepare Pages artifact
        run: |
          OUTPUT_DIR="${{ inputs.output_dir || 'output' }}"
          PAGES_DIR="pages"
          mkdir -p "$PAGES_DIR"
          cp "web/index.html" "$PAGES_DIR/index.html"
          cp "$OUTPUT_DIR/cgm.json" "$PAGES_DIR/cgm.json"
          if [ -f "$OUTPUT_DIR/events.json" ]; then
            cp "$OUTPUT_DIR/events.json" "$PAGES_DIR/events.json"
          fi
          if [ -f "$OUTPUT_DIR/metrics.json" ]; then
            cp "$OUTPUT_DIR/metrics.json" "$PAGES_DIR/metrics.json"
          fi
          if [ -f "$OUTPUT_DIR/report.json" ]; then
            cp "$OUTPUT_DIR/report.json" "$PAGES_DIR/report.json"
          fi
          if [ -f "$OUTPUT_DIR/report.md" ]; then
            cp "$OUTPUT_DIR/report.md" "$PAGES_DIR/report.md"
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
