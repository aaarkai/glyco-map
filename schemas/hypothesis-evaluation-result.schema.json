{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/glyco-map/schemas/1.0.0/hypothesis-evaluation-result.schema.json",
  "title": "Hypothesis Evaluation Result",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "evaluation_id",
    "subject_id",
    "time_zone",
    "generated_at",
    "hypothesis",
    "answerability"
  ],
  "properties": {
    "schema_version": {
      "$ref": "#/$defs/semver"
    },
    "evaluation_id": {
      "type": "string",
      "minLength": 1
    },
    "subject_id": {
      "type": "string",
      "minLength": 1
    },
    "time_zone": {
      "$ref": "#/$defs/time_zone"
    },
    "generated_at": {
      "$ref": "#/$defs/date_time_tz"
    },
    "hypothesis": {
      "$ref": "#/$defs/hypothesis"
    },
    "answerability": {
      "$ref": "#/$defs/answerability"
    },
    "evidence": {
      "$ref": "#/$defs/evidence"
    }
  },
  "if": {
    "properties": {
      "answerability": {
        "properties": {
          "answerable": {
            "const": true
          }
        },
        "required": ["answerable"]
      }
    }
  },
  "then": {
    "required": ["evidence"]
  },
  "$defs": {
    "semver": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "time_zone": {
      "type": "string",
      "pattern": "^[A-Za-z0-9_+.-]+/[A-Za-z0-9_+.-]+(?:/[A-Za-z0-9_+.-]+)?$",
      "description": "IANA time zone name such as America/Los_Angeles."
    },
    "date_time_tz": {
      "type": "string",
      "format": "date-time",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{1,9})?(Z|[+-]\\d{2}:\\d{2})$",
      "description": "RFC 3339 timestamp with explicit timezone (Z or offset)."
    },
    "window": {
      "type": "object",
      "additionalProperties": false,
      "required": ["relative_to", "start_offset_minutes", "end_offset_minutes"],
      "properties": {
        "relative_to": {
          "type": "string",
          "enum": ["event_start", "event_end"]
        },
        "start_offset_minutes": {
          "type": "number"
        },
        "end_offset_minutes": {
          "type": "number"
        }
      }
    },
    "exposure_definition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["event_type", "component", "operator", "value", "unit"],
      "properties": {
        "event_type": {
          "type": "string",
          "minLength": 1
        },
        "component": {
          "type": "string",
          "minLength": 1
        },
        "operator": {
          "type": "string",
          "enum": ["=", "<", ">", "<=", ">=", "between", "in", "exists"]
        },
        "value": {
          "oneOf": [
            {"type": "number"},
            {"type": "string"},
            {"type": "boolean"},
            {"type": "array", "minItems": 1}
          ]
        },
        "unit": {
          "type": "string",
          "minLength": 1
        },
        "description": {
          "type": "string"
        }
      }
    },
    "outcome_metric": {
      "type": "object",
      "additionalProperties": false,
      "required": ["metric_name", "window", "unit"],
      "properties": {
        "metric_name": {
          "type": "string",
          "minLength": 1
        },
        "window": {
          "$ref": "#/$defs/window"
        },
        "unit": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "hypothesis": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "hypothesis_id",
        "exposure_definition",
        "outcome_metric",
        "counterfactual",
        "time_span",
        "assumptions"
      ],
      "properties": {
        "hypothesis_id": {
          "type": "string",
          "minLength": 1
        },
        "exposure_definition": {
          "$ref": "#/$defs/exposure_definition"
        },
        "outcome_metric": {
          "$ref": "#/$defs/outcome_metric"
        },
        "counterfactual": {
          "type": "object",
          "additionalProperties": false,
          "required": ["description"],
          "properties": {
            "description": {
              "type": "string",
              "minLength": 1
            }
          }
        },
        "time_span": {
          "type": "object",
          "additionalProperties": false,
          "required": ["start_time", "end_time"],
          "properties": {
            "start_time": {
              "$ref": "#/$defs/date_time_tz"
            },
            "end_time": {
              "$ref": "#/$defs/date_time_tz"
            }
          }
        },
        "assumptions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "answerability": {
      "type": "object",
      "additionalProperties": false,
      "required": ["answerable", "criteria_checked"],
      "properties": {
        "answerable": {
          "type": "boolean"
        },
        "criteria_checked": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "failed_checks": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "notes": {
          "type": "string"
        }
      }
    },
    "diagnostic": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "status"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "status": {
          "type": "string",
          "enum": ["pass", "fail", "warn"]
        },
        "details": {
          "type": "string"
        }
      }
    },
    "uncertainty": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["ci", "credible_interval", "se", "sd"]
        },
        "level": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "lower": {
          "type": "number"
        },
        "upper": {
          "type": "number"
        }
      }
    },
    "evidence": {
      "type": "object",
      "additionalProperties": false,
      "required": ["estimation_method", "effect_estimate", "diagnostics", "provenance"],
      "properties": {
        "estimation_method": {
          "type": "string",
          "minLength": 1
        },
        "effect_estimate": {
          "type": "object",
          "additionalProperties": false,
          "required": ["value", "unit"],
          "properties": {
            "value": {
              "type": "number"
            },
            "unit": {
              "type": "string",
              "minLength": 1
            },
            "direction": {
              "type": "string",
              "enum": ["increase", "decrease", "no_change", "mixed"]
            }
          }
        },
        "uncertainty": {
          "$ref": "#/$defs/uncertainty"
        },
        "diagnostics": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/diagnostic"
          }
        },
        "provenance": {
          "type": "object",
          "additionalProperties": false,
          "required": ["series_id", "event_ids"],
          "properties": {
            "series_id": {
              "type": "string",
              "minLength": 1
            },
            "event_ids": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "minLength": 1
              }
            },
            "metric_set_id": {
              "type": "string",
              "minLength": 1
            }
          }
        }
      }
    }
  }
}
